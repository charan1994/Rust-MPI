Bootstrap: docker
From: debian:stretch

%environment

    export I_MPI_ROOT=/opt/intel/oneapi/mpi/2021.1.1
    export PLATFORM=

    LD_LIBRARY_PATH="${I_MPI_ROOT}/${PLATFORM}/lib/release:${I_MPI_ROOT}/${PLATFORM}/lib:${LD_LIBRARY_PATH}"; export LD_LIBRARY_PATH
    LIBRARY_PATH="${I_MPI_ROOT}/${PLATFORM}/lib/release:${I_MPI_ROOT}/${PLATFORM}/lib:${LIBRARY_PATH}"; export LIBRARY_PATH
    CPATH="${I_MPI_ROOT}/${PLATFORM}/include:${CPATH}"; export CPATH

    PATH="${I_MPI_ROOT}/${PLATFORM}/libfabric/bin:${PATH}"; export PATH

    LD_LIBRARY_PATH="${I_MPI_ROOT}/${PLATFORM}/libfabric/lib:${LD_LIBRARY_PATH}"; export LD_LIBRARY_PATH
    LIBRARY_PATH="${I_MPI_ROOT}/${PLATFORM}/libfabric/lib:${LIBRARY_PATH}"; export LIBRARY_PATH

    FI_PROVIDER_PATH="${I_MPI_ROOT}/${PLATFORM}/libfabric/lib/prov"; export FI_PROVIDER_PATH

%post
    MPI_ROOT=/opt/intel/oneapi/mpi/2021.1.1

    # package IB, RDMA and SHMEM components
    PACKAGES="g++ librdmacm1 curl ca-certificates autoconf automake libtool libltdl-dev libfabric-dev wget lsb-release software-properties-common gnupg apt-transport-https"
    wget https://apt.llvm.org/llvm.sh
    chmod +x llvm.sh
    ./llvm.sh

    apt-get update -y
    apt-get install -y --no-install-recommends $PACKAGES

    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    /bin/bash -c "source $HOME/.cargo/env"
    /bin/bash -c "source $MPI_ROOT/env/vars.sh"

    # cmake or any other build system goes here
    cd /opt/allToAll
    #cargo build --release

    # clean unwanted content (including MPI)
    apt clean

    rm -rf /var/lib/apt/lists/*
    rm -rf /var/tmp/*

    rm -rf /intel-mpi

%runscript
    /bin/bash -c "$HOME/.cargo/env" && cd /opt/allToAll/target/release && ./allToAll

%files
    # as per on access node /util/academic/intel/20.1/compilers_and_libraries_2020.1.217/linux/mpi /intel-mpi
    /opt/intel/oneapi/mpi/2021.1.1/ /opt/intel/oneapi/mpi/
    #/opt/intel/oneapi/compiler/2021.1.2/ /opt/intel/oneapi/compiler/
    allToAll/ /opt/

